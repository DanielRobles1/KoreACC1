<app-polizas-layout
  [open]="sidebarOpen"
  (openChange)="onSidebarToggle($event)">
<div style="display:flex; align-items:center; gap:.5rem; margin-bottom:1rem;">
  <a [routerLink]="['/poliza-home']" style="text-decoration:none;">
  <button
    type="button"
    style="background:none; border:none; cursor:pointer; padding:0;">
    <svg
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      width="24"
      height="24">
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
  </button>
</a>

  <span page-title>Pólizas</span>
</div>

  

  <div page-actions class="toolbar-filters">
    <input
      #xmlInput
      type="file"
      accept=".xml,text/xml,application/xml"
      hidden
      (change)="onXmlPicked($event)" />

    <span *ngIf="selectedXmlName" style="margin-left:.5rem; color:#e9eef5;">
      {{ selectedXmlName }}
    </span>
    <span *ngIf="uploadXmlError" style="margin-left:.5rem; color:#ffb4b4;">
      {{ uploadXmlError }}
    </span>
  </div>

  <!-- Contenido -->
  <div class="polizas-container">
    <h2>Pólizas registradas</h2>

    <button type="button" class="pill-btn" routerLink="/polizas">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      Nueva póliza
    </button>

    <!-- Buscador -->
    <input
      type="search"
      [(ngModel)]="q"
      (ngModelChange)="onBuscarChange($event)"
      placeholder="Buscar pólizas por folio, concepto, UUID, cliente…"
      style="min-width:280px; padding:.45rem .6rem; border-radius:10px; border:1px solid rgba(10, 10, 10, 0.25); background:transparent; color:#0a0a0a; outline:none; margin-bottom:.75rem; margin-left:1rem;" />

    <table class="tabla-polizas">
      <thead>
        <tr>
          <th>Ver más</th>
          <th>Folio</th>
          <th>Concepto</th>
          <th>Centro</th>
          <th>Tipo</th>
          <th>Periodo</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>

      <tbody>
        <ng-container *ngFor="let p of (polizasFiltradas ?? []); trackBy: trackByFolio">
          <!-- Fila principal -->
          <tr>
            <!-- Ver más -->
            <td
              (click)="toggleVerMas(p)"
              style="cursor:pointer; user-select:none; white-space:nowrap;">
              <span>{{ expandedId === getIdPoliza(p) ? 'Ocultar' : 'Ver más' }}</span>
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                width="18"
                height="18"
                style="vertical-align:middle; margin-left:.35rem; transition:transform .15s;"
                [style.transform]="expandedId === getIdPoliza(p) ? 'rotate(180deg)' : 'rotate(0deg)'">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </td>

            <td>{{ p.folio }}</td>
            <td>{{ p.concepto }}</td>
            <td>{{ nombreCentro(p.id_centro) }}</td>
            <td>{{ nombreTipo(p.id_tipopoliza) }}</td>
            <td>{{ nombrePeriodo(p.id_periodo) }}</td>
            <td><span [class]="estadoClass(p)">{{ getEstado(p) }}</span></td>

            <!-- Acciones -->
            <td>
              <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
                <!-- Revisada -->
                <button
                  type="button"
                  (click)="cambiarEstadoPoliza(p, 'Revisada')"
                  [disabled]="loadingId === getIdPoliza(p) || !canMarcarRevisada(p)"
                  title="Marcar como Revisada"
                  class="icon-btn"
                  [ngStyle]="{
                    cursor: 'pointer',
                    opacity: (loadingId === getIdPoliza(p) || !canMarcarRevisada(p)) ? 0.5 : 1
                  }">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="black"
                    stroke-width="2"
                    width="20"
                    height="20">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>

                <!-- Editar -->
                <button
                  class="icon-btn"
                  (click)="editarPoliza(p)"
                  title="Editar"
                  aria-label="Editar póliza">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    width="20"
                    height="20">
                    <path d="M12 20h9"></path>
                    <path
                      d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
                  </svg>
                </button>

                <!-- Eliminar -->
                <button
                  class="icon-btn danger"
                  (click)="eliminarPoliza(p.id_poliza)"
                  title="Eliminar"
                  aria-label="Eliminar póliza">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    width="20"
                    height="20">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path
                      d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"></path>
                    <path d="M10 11v6"></path>
                    <path d="M14 11v6"></path>
                    <path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"></path>
                  </svg>
                </button>
              </div>
            </td>
          </tr>

         <!-- Fila expandible: SOLO movimientos con las columnas solicitadas -->
<tr *ngIf="expandedId === getIdPoliza(p)">
  <td colspan="8" style="background:rgba(255,255,255,0.04); border-top:1px solid rgba(255,255,255,.1);">
    <div style="padding:1rem;">
      <h4 style="margin-bottom:.5rem;">Movimientos</h4>

      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="text-align:left; background:rgba(255,255,255,.06);">
            <th style="padding:.5rem .6rem;">ID Cuenta</th>
            <th style="padding:.5rem .6rem;">Ref. Serie Venta</th>
            <th style="padding:.5rem .6rem;">Operación</th>
            <th style="padding:.5rem .6rem;">Monto</th>
            <th style="padding:.5rem .6rem;">Cliente</th>
            <th style="padding:.5rem .6rem;">Fecha</th>
            <th style="padding:.5rem .6rem;">Centro Costo</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let m of p?.movimientos; let i = index" style="border-top:1px solid rgba(255,255,255,.08);">
            <td style="padding:.45rem .6rem;">{{ cuentaEtiqueta(m?.id_cuenta) }}</td>
            <td style="padding:.45rem .6rem;">{{ m?.ref_serie_venta || '—' }}</td>
            <td style="padding:.45rem .6rem;">{{ (m?.operacion == '0' || m?.operacion == 0) ? 'Cargo' : 'Abono' }}</td>
            <td style="padding:.45rem .6rem;">{{ m?.monto | currency:'MXN':'symbol':'1.2-2' }}</td>
            <td style="padding:.45rem .6rem;">{{ m?.cliente || '—' }}</td>
            <td style="padding:.45rem .6rem;">{{ m?.fecha ? (m.fecha | date:'yyyy-MM-dd') : '—' }}</td>
            <td style="padding:.45rem .6rem;">{{ m?.cc }}</td>
          </tr>

          <tr *ngIf="!p?.movimientos?.length">
            <td colspan="7" style="padding:.75rem; text-align:center; opacity:.75;">
              No hay movimientos registrados para esta póliza.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </td>
</tr>

 


        </ng-container>
      </tbody>
    </table>
  </div>
  
</app-polizas-layout>

<app-toast-message
  [open]="toast.open"
  [title]="toast.title"
  [message]="toast.message"
  [type]="toast.type"
  [position]="toast.position"
  [autoCloseMs]="toast.autoCloseMs"
  [showClose]="toast.showClose"
  (closed)="onToastClosed()">
</app-toast-message>
<app-modal
  [open]="confirmModal.open"
  [title]="confirmModal.title"
  (confirmed)="confirmarConfirmModal()"
  (canceled)="cerrarConfirmModal()"
  (closed)="cerrarConfirmModal()"
>
  {{ confirmModal.message }}
</app-modal>


