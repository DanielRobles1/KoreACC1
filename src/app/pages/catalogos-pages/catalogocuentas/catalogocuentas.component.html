<div class="layout" [class.is-collapsed]="!sidebarOpen">
  <app-sidebar
    class="sidebar"
    [open]="sidebarOpen"
    (openChange)="onSidebarToggle($event)">
  </app-sidebar>

  <div class="content">
    <div class="export-bar">
      <button class="btn-excel" (click)="exportToExcel()">Exportar Excel</button>
      <button class="btn-pdf" (click)="exportToPDF()">Exportar PDF</button>

      <button type="button" class="btn-import" (click)="openImportHelp()">
        Importar Excel
      </button>

      <!-- input escondido; se dispara después del modal -->
      <input
        #excelInput
        type="file"
        accept=".xlsx, .xls"
        style="display:none"
        (change)="importFromExcel($event)" />
    </div>

    <!-- Modal de guía de importación -->
    <app-modal
      [open]="importHelpOpen"
      [title]="'Guía para importar Catálogo de Cuentas'"
      [size]="'lg'"
      [showClose]="true"
      (closed)="closeImportHelp()"
      (canceled)="closeImportHelp()"
      (confirmed)="proceedImportFile()"
    >
      <div style="display:grid;gap:10px;line-height:1.4">
        <p style="margin:0;">
          Para importar correctamente, el Excel debe contener una hoja con encabezados y las siguientes columnas:
        </p>

        <div>
          <strong>Columnas obligatorias</strong>
          <ul style="margin:6px 0 0 18px;">
            <li><code>codigo</code> (único, requerido)</li>
            <li><code>nombre</code> (requerido)</li>
            <li><code>tipo</code> = ACTIVO | PASIVO | CAPITAL | INGRESO | GASTO</li>
            <li><code>naturaleza</code> = DEUDORA | ACREEDORA</li>
            <li><code>ctaMayor</code> (boolean: 1/0 o TRUE/FALSE o Sí/No)</li>
            <li><code>posteable</code> (boolean: 1/0 o TRUE/FALSE o Sí/No)</li>
          </ul>
        </div>

        <div>
          <strong>Jerarquía (opcional)</strong>
          <ul style="margin:6px 0 0 18px;">
            <li><code>parentCodigo</code> (código del padre). Dejar vacío si es cuenta raíz.</li>
          </ul>
          <small style="opacity:.8;display:block;margin-top:6px;">
            Nota: La base guarda <code>parentId</code>, pero para Excel se recomienda usar <code>parentCodigo</code>.
          </small>
        </div>

        <div>
          <strong>Ejemplo</strong>
          <pre style="margin:0;background:#1111;color:inherit;padding:10px;border-radius:8px;overflow:auto;">
    codigo,nombre,tipo,naturaleza,ctaMayor,posteable,parentCodigo
    1000000000,ACTIVO,ACTIVO,DEUDORA,1,0,
    1100000000,CIRCULANTE,ACTIVO,DEUDORA,1,0,1000000000
    1101000000,CAJA,ACTIVO,DEUDORA,0,1,1100000000
          </pre>
        </div>

        <small style="opacity:.8;">
          Si hay códigos duplicados o valores fuera del ENUM, la importación puede fallar o marcar registros como omitidos.
        </small>
      </div>
    </app-modal>

    <app-crud-panel
      [title]="title"
      
      [activeTabId]="activeTabId"
      (tabChange)="onTabChange($event)"

      [primaryActionLabel]="primaryActionLabel"
      (primaryAction)="onPrimary()"
      [disablePrimary]="!canCreate"

      [projectContent]="true"
      (search)="onSearch($event)"
    >
      <ul class="tree-root">
        <ng-container *ngFor="let root of filteredTreeRoots; trackBy: trackByCuentaNodeId">
          <ng-container
            *ngTemplateOutlet="treeNode; context: { $implicit: root }">
          </ng-container>
        </ng-container>
      </ul>

      <ng-template #treeNode let-node>
        <li class="tree-node" [class.is-leaf]="!node.children?.length">
          <div class="tree-node__row" (click)="toggleNode(node, $event)">
            <button
              type="button"
              class="tree-toggle"
              *ngIf="node.children?.length"
              (click)="toggleNode(node, $event)"
              aria-label="Expandir/contraer">
              {{ node.expanded ? '▾' : '▸' }}
            </button>

            <span class="tree-node__label">
              {{ node.data.codigo }} — {{ node.data.nombre }}
              <small>
                ({{ node.data.tipo }}/{{ node.data.naturaleza }})
              </small>
            </span>

            <span
              class="tree-pill"
              [ngClass]="node.data.ctaMayor ? 'tree-pill--mayor' : 'tree-pill--sub'">
              {{ node.data.ctaMayor ? 'Mayor' : 'Subcuenta' }}
            </span>

            <button
              type="button"
              class="tree-action"
              *ngIf="canEdit"
              (click)="onEdit(node.data); $event.stopPropagation()"
              aria-label="Editar cuenta">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                   width="20" height="20" role="img" aria-hidden="true">
                <path d="M12 20h9"></path>
                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
              </svg>
            </button>

            <button
              type="button"
              class="tree-action tree-action--danger"
              *ngIf="canDelete"
              (click)="askDelete(node.data, $event)"
              aria-label="Eliminar cuenta">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                   width="18" height="18" role="img" aria-hidden="true">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"></path>
                <path d="M10 11v6"></path>
                <path d="M14 11v6"></path>
                <path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"></path>
              </svg>
            </button>
          </div>

          <ul *ngIf="node.expanded && node.children?.length">
            <ng-container *ngFor="let child of node.children; trackBy: trackByCuentaNodeId">
              <ng-container
                *ngTemplateOutlet="treeNode; context: { $implicit: child }">
              </ng-container>
            </ng-container>
          </ul>
        </li>
      </ng-template>
    </app-crud-panel>
  </div>
</div>

<!-- Modal de edición -->
<app-modal
  [open]="editOpen"
  [title]="modalTitle"
  [size]="modalSize"
  [showClose]="showClose"
  (closed)="closeModal()"
  (canceled)="cancelModal()"
  (confirmed)="confirmModal()">

  <form #cuentaForm="ngForm" style="display: grid; gap: 10px;">
    <div>
      <label class="field-label required">Código</label>
      <input class="field-input" type="text" name="codigo"
             [(ngModel)]="formCuenta.codigo"
             (ngModelChange)="onFieldChange('codigo', $event)"
             required maxlength="20" placeholder="Ej. 1000 o 1001-01" />
      <small *ngIf="touched.codigo && errors.codigo"
             style="color:rgb(247,39,39);display:block;margin-top:4px;font-weight:bold;">
        {{ errors.codigo }}
      </small>
    </div>

    <div>
      <label class="field-label required">Nombre de cuenta</label>
      <input class="field-input" type="text" name="nombre"
             [(ngModel)]="formCuenta.nombre"
             (ngModelChange)="onFieldChange('nombre', $event)"
             required maxlength="100" placeholder="Ej. Caja general, Banco BBVA, Ventas" />
      <small *ngIf="touched.nombre && errors.nombre"
             style="color:rgb(247,58,58);display:block;margin-top:4px;font-weight:bold;">
        {{ errors.nombre }}
      </small>
    </div>

    <div style="display:flex;align-items:center;gap:8px;">
      <label class="field-label" style="margin:0;">¿Es cuenta mayor?</label>
      <input
        type="checkbox"
        name="ctaMayor"
        [(ngModel)]="formCuenta.ctaMayor"
        (ngModelChange)="onCtaMayorChange($event)" />
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <div>
        <label class="field-label required">Tipo</label>
        <select class="field-input" name="tipo" required [(ngModel)]="formCuenta.tipo">
          <option *ngFor="let t of TIPO_OPTS" [ngValue]="t">{{ t }}</option>
        </select>
      </div>
      <div>
        <label class="field-label required">Naturaleza</label>
        <select class="field-input" name="naturaleza" required [(ngModel)]="formCuenta.naturaleza">
          <option *ngFor="let n of NAT_OPTS" [ngValue]="n">{{ n }}</option>
        </select>
      </div>
    </div>

    <!-- <div style="display:flex;align-items:center;gap:8px;">
      <label class="field-label" style="margin:0;">Posteable</label>
      <input type="checkbox" name="posteable"
             [(ngModel)]="formCuenta.posteable"
             [disabled]="!!formCuenta.ctaMayor" />
      <span style="font-size:12px;opacity:.8;">
        <ng-container *ngIf="!!formCuenta.ctaMayor">(Las cuentas mayor no son posteables)</ng-container>
        <ng-container *ngIf="!formCuenta.ctaMayor">(Las subcuentas pueden ser posteables)</ng-container>
      </span>
    </div> -->

    <select
      class="field-input"
      name="parentId"
      [(ngModel)]="formCuenta.parentId"
      (ngModelChange)="onParentChange($event)"
      [disabled]="!!formCuenta.ctaMayor">
      <option [ngValue]="null">— Sin padre —</option>
      <option *ngFor="let c of getParentOptions()" [ngValue]="c.id">
        {{ c.codigo }} - {{ c.nombre }}
      </option>
    </select>

    <div *ngIf="!!formCuenta.ctaMayor" style="font-size:12px;opacity:.8;margin-top:4px;">
      Las cuentas mayor no pueden tener padre.
    </div>

    <div *ngIf="!formCuenta.ctaMayor && !!parentPreselectedId" style="font-size:12px;opacity:.8;margin-top:4px;">
      Se creará como subcuenta de <strong>{{ getCodigoPadre(parentPreselectedId) }}</strong>
    </div>
  </form>
</app-modal>

<!-- Modal de confirmación -->
<app-modal
  [open]="confirmOpen"
  [title]="confirmTitle"
  [size]="'sm'"
  [showClose]="true"
  (closed)="closeConfirm()"
  (canceled)="cancelConfirm()"
  (confirmed)="confirmProceed()">
  <p style="margin:0">{{ confirmMessage }}</p>
</app-modal>

<!-- Toast -->
<app-toast-message
  [open]="vm.open"
  [title]="vm.title"
  [message]="vm.message"
  [type]="vm.type"
  position="top-right"
  [autoCloseMs]="vm?.autoCloseMs ?? 3500"
  (closed)="vm.open = false">
</app-toast-message>