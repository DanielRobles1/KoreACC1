<app-polizas-layout
  [open]="sidebarOpen"
  (openChange)="onSidebarToggle($event)">

  <!-- Volver -->
  <a [routerLink]="['/poliza-home']" style="text-decoration:none;">
    <button type="button" class="icon-btn" aria-label="Volver">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>
  </a>

  <!-- Toolbar superior (no usa movs-toolbar para evitar sangrado) -->

 

  <div class="polizas-container">
    <hr />

    <h3>Nueva póliza</h3>

    <!-- Toggle MANUAL / MOTOR -->
    <div class="mode-switch">
      <label class="mode-switch__check">
        <input
          type="checkbox"
          [checked]="modoCaptura === 'motor'"
          (change)="modoCaptura = (modoCaptura==='manual' ? 'motor' : 'manual')"
          aria-label="Usar motor" />
        <span>Usar motor</span>
      </label>
      <small *ngIf="modoCaptura==='manual'">Captura manual de movimientos</small>
      <small *ngIf="modoCaptura==='motor'">Generación automática (flujo + contrapartida + impuestos)</small>
    </div>

    <form
      class="form-poliza"
      (ngSubmit)="guardarPoliza()"
      #polizaForm="ngForm"
      autocomplete="off"
      novalidate>

      <h4 class="section-title">Cabecera de póliza</h4>

      <!-- Encabezado -->
      <div
  style="
    margin-left: auto;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 8px;
    padding: 0.35rem 0.75rem;
    font-size: 0.9rem;
    color: #565656;
    display: flex;
    align-items: center;
    gap: 0.8rem; /* más separación entre bloques */
  "
>
  <!-- Ejercicio -->
  <div style="display: flex; align-items: center; gap: 0.4rem;">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
      <path d="M3 4h18v2H3zM8 10h13v2H8zM8 16h13v2H8zM3 10h2v2H3zM3 16h2v2H3z"></path>
    </svg>
    <strong>Ejercicio:</strong>
    <select
      [(ngModel)]="ejercicioActualId"
      (ngModelChange)="onEjercicioSeleccionado($event)"
      name="ejercicioSeleccionado"
      style="margin-left: 0.5rem; background: transparent; border: none; color: #565656;"
    >
      <option *ngFor="let e of ejercicios" [value]="e.id_ejercicio">
        {{ e.nombre }} ({{ e.fecha_inicio || '—' }} — {{ e.fecha_fin || '—' }})
      </option>
    </select>
    <span *ngIf="!ejercicios?.length" style="margin-left: 0.5rem;">—</span>
  </div>

  <!-- Separador visual -->
  <div style="width: 1px; height: 20px; background: #ccc; opacity: 0.4;"></div>

  <!-- Usuario -->
  <div style="display: flex; align-items: center; gap: 0.4rem;">
    <svg
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      aria-hidden="true"
    >
      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
      <circle cx="12" cy="7" r="4"></circle>
    </svg>
    <span class="user-name">{{ currentUserLabel || 'Usuario' }}</span>
  </div>

  <!-- Separador visual -->
  <div style="width: 1px; height: 20px; background: #ccc; opacity: 0.4;"></div>

 <div class="status-chip por-revisar">
  <svg
    width="14"
    height="14"
    viewBox="0 0 24 24"
    fill="none"
    stroke="black"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <circle cx="12" cy="12" r="10"></circle>
    <line x1="12" y1="8" x2="12" y2="12"></line>
    <circle cx="12" cy="16" r="1"></circle>
  </svg>
  <span>Por revisar</span>
</div>

</div>


      <div class="form-grid">

        <label>
          Tipo póliza:
          <select
            class="field select"
            [(ngModel)]="nuevaPoliza.id_tipopoliza"
            name="id_tipopoliza"
            required
            (ngModelChange)="onTipoPolizaChange($event)">
            <option [ngValue]="undefined" disabled>Seleccione…</option>
            <option *ngFor="let t of tiposPoliza" [ngValue]="t.id_tipopoliza">{{ t.nombre }}</option>
          </select>
        </label>

        <label>
          Centro de costo:
          <select
            class="field select"
            [(ngModel)]="nuevaPoliza.id_centro"
            name="id_centro"
            required
            (change)="onCentroSeleccionado(); onCentroCambiadoPropagarSerie()">
            <option [ngValue]="undefined" disabled>Seleccione…</option>
            <option *ngFor="let c of centros" [ngValue]="c.id_centro">{{ c.nombre }}</option>
          </select>
        </label>

        <label>
          Folio:
          <input class="field" [(ngModel)]="nuevaPoliza.folio" name="folio" required />
        </label>

        <label>
          Concepto:
          <input class="field"
                 [(ngModel)]="nuevaPoliza.concepto"
                 name="concepto"
                 required
                 (input)="conceptoFueEditadoPorUsuario = true" />

          <small *ngIf="conceptoSugerido && (!nuevaPoliza.concepto || !conceptoFueEditadoPorUsuario)"
                 style="display:block;margin-top:.25rem;color:#6b7280">
            Sugerencia: <em>{{ conceptoSugerido }}</em>
            <button type="button" class="btn small"
                    style="margin-left:.5rem"
                    (click)="aplicarConceptoSugerido()">
              Usar
            </button>
          </small>
        </label>

        <label>
          Periodo:
          <select class="field select" [(ngModel)]="nuevaPoliza.id_periodo" name="id_periodo" required>
            <option [ngValue]="undefined" disabled>Seleccione…</option>
            <option *ngFor="let p of periodos" [ngValue]="p.id_periodo">{{ p.nombre }}</option>
          </select>
        </label>
      </div>

      <!-- Panel del motor -->
      <div *ngIf="modoCaptura==='motor'" class="motor-panel">
        <h4>Evento (motor)</h4>
        <div class="form-grid">
          <label> Tipo de operación:
            <select class="field select" [(ngModel)]="evento.tipo_operacion" [ngModelOptions]="{standalone:true}">
              <option [ngValue]="'ingreso'">Ingreso</option>
              <option [ngValue]="'egreso'">Egreso</option>
            </select>
          </label>

          <label> Monto base:
            <input class="field" type="number" [(ngModel)]="evento.monto_base" [ngModelOptions]="{standalone:true}" min="0" step="0.01">
          </label>

          <label> Fecha operación:
            <input class="field" type="date" [(ngModel)]="evento.fecha_operacion" [ngModelOptions]="{standalone:true}">
          </label>

          <label> Medio:
            <select class="field select" [(ngModel)]="evento.medio_cobro_pago" [ngModelOptions]="{standalone:true}">
              <option [ngValue]="'bancos'">Bancos</option>
              <option [ngValue]="'caja'">Caja</option>
              <option [ngValue]="'clientes'">Clientes</option>
              <option [ngValue]="'proveedores'">Proveedores</option>
            </select>
          </label>

          <!-- Cuenta contrapartida -->
          <label> Cuenta contrapartida:
            <select
              class="field select"
              [(ngModel)]="evento.id_cuenta_contrapartida"
              [ngModelOptions]="{standalone:true}">
              <option [ngValue]="null">— Selecciona cuenta —</option>
              <option *ngFor="let c of getCuentasFiltradasGlobal()" [ngValue]="c.id_cuenta">
                {{ c.codigo }} — {{ c.nombre }}
              </option>
            </select>
            <div class="hint" *ngIf="evento.id_cuenta_contrapartida">
              Seleccionada: <strong>{{ labelCuenta(evento.id_cuenta_contrapartida) }}</strong>
            </div>
          </label>

          <label> Cliente:
            <input class="field" [(ngModel)]="evento.cliente" [ngModelOptions]="{standalone:true}">
          </label>

          <label> Ref. Serie:
            <input class="field" [(ngModel)]="evento.ref_serie_venta" [ngModelOptions]="{standalone:true}">
          </label>

          <label> Centro de costo:
            <select class="field select" [(ngModel)]="evento.cc" [ngModelOptions]="{standalone:true}">
              <option [ngValue]="null">— Selecciona CC —</option>
              <option *ngFor="let cc of centrosCosto" [ngValue]="cc.id_centrocosto">
                {{ cc.nombre }}
              </option>
            </select>
          </label>
        </div>
      </div>

      <!-- Tabla de movimientos (solo manual) -->
      <div *ngIf="modoCaptura==='manual'">
        <div class="movs-header">
          <h4 class="section-title">Movimientos</h4>
          <button type="button" class="btn pill" (click)="agregarMovimiento()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"
                 stroke-linecap="round" stroke-linejoin="round" class="icon">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Agregar movimiento
          </button>
        </div>

        <div class="tabla-wrapper">
          <table class="tabla-movimientos">
            <thead>
              <tr>
                <th>Cuenta</th>
                <th>Ref. Serie Venta</th>
                <th>Operación</th>
                <th>Monto</th>
                <th>Concepto</th>
                <th>Fecha</th>
                <th>Centro Costo</th>
                <th>UUID</th>
                <th></th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let mov of (nuevaPoliza.movimientos ?? []); let i = index">
                <td class="cell-cuenta">
                  <button type="button" class="btn small" (click)="abrirModalCuentas(i)">
                    {{ labelCuenta(mov.id_cuenta) || 'Seleccionar cuenta…' }}
                  </button>
                </td>

                <td><input class="cell-input" [(ngModel)]="mov.ref_serie_venta" name="ref_serie_venta{{i}}" /></td>

                <td>
                  <select class="cell-input select" [(ngModel)]="mov.operacion" name="operacion{{i}}" required>
                    <option [ngValue]="''" disabled>Selecciona…</option>
                    <option [ngValue]="'0'">Cargo</option>
                    <option [ngValue]="'1'">Abono</option>
                  </select>
                </td>

                <td><input class="cell-input" type="number" [(ngModel)]="mov.monto" name="monto{{i}}" min="0" step="0.01" required /></td>
                <td><input class="cell-input" [(ngModel)]="mov.cliente" name="cliente{{i}}" /></td>
                <td><input class="cell-input cell-date" type="date" [(ngModel)]="mov.fecha" name="fecha{{i}}" /></td>

                <td>
                  <select
                    class="cell-input select"
                    [(ngModel)]="mov.cc"
                    name="cc{{i}}"
                    (ngModelChange)="onMovimientoCcChange(i, $event)">
                    <option [ngValue]="null">— Selecciona CC —</option>
                    <option *ngFor="let cc of centrosCosto" [ngValue]="cc.id_centrocosto">
                      {{ cc.nombre }}
                    </option>
                  </select>
                </td>

                <td class="uuid-cell">
                  <div class="uuid-wrapper" [class.has-uuid]="!!mov.uuid">
                    <button
                      type="button"
                      class="btn-xml"
                      [ngClass]="{ ok: !!mov.uuid }"
                      [title]="mov.uuid ? 'XML asociado' : 'Cargar XML'"
                      (click)="triggerXmlPickerForMovimiento(xmlInputMov, i)">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                           width="18" height="18" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 5v14m-7-7h14"/>
                      </svg>
                    </button>

                    <input
                      #xmlInputMov
                      type="file"
                      accept=".xml,text/xml,application/xml"
                      hidden
                      (change)="onXmlPickedForMovimiento($event, i)" />

                    <!-- Badge opcional con el UUID recortado -->
                    <small class="uuid-badge" *ngIf="mov.uuid">{{ mov.uuid | slice:0:8 }}…</small>
                  </div>
                </td>

                <td class="actions-cell">
                  <button type="button" class="icon-btn danger" (click)="eliminarMovimiento(i)" title="Eliminar movimiento" aria-label="Eliminar movimiento">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"></path>
                      <path d="M10 11v6"></path>
                      <path d="M14 11v6"></path>
                      <path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"></path>
                    </svg>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Totales -->
        <div class="totales-panel">
          <div class="tot-card">
            <div class="tot-label">TOTAL CARGOS</div>
            <div class="tot-value">{{ getTotal(nuevaPoliza, '0') | number:'1.2-2' }}</div>
          </div>

          <div class="tot-card">
            <div class="tot-label">TOTAL ABONOS</div>
            <div class="tot-value">{{ getTotal(nuevaPoliza, '1') | number:'1.2-2' }}</div>
          </div>

          <div class="tot-card">
            <div class="tot-label font-semibold"
                 [style.color]="getDiferencia($any(nuevaPoliza)) === 0 ? '#16a34a' : '#dc2626'">
              DIFERENCIA
            </div>
            <div class="tot-value font-bold"
                 [style.color]="getDiferencia($any(nuevaPoliza)) === 0 ? '#16a34a' : '#dc2626'">
              {{ getDiferencia($any(nuevaPoliza)) | number:'1.2-2' }}
            </div>
          </div>

          <div class="pill-status"
               [ngClass]="{ 'ok': getDiferencia($any(nuevaPoliza)) === 0, 'bad': getDiferencia($any(nuevaPoliza)) !== 0 }">
            <span class="icon" aria-hidden="true">
              {{ getDiferencia($any(nuevaPoliza)) === 0 ? '✔' : '⚠' }}
            </span>
            <span class="text">
              {{ getDiferencia($any(nuevaPoliza)) === 0 ? 'Póliza cuadrada' : 'No cuadra' }}
            </span>
          </div>
        </div>
      </div> <!-- /modo manual -->

      <div class="actions">
        <span *ngIf="!canGuardar()" class="hint error">
          <ng-container *ngIf="modoCaptura==='manual'">
            Completa folio, concepto, tipo, periodo, centro, usuario y cuadra partida doble.
          </ng-container>
          <ng-container *ngIf="modoCaptura==='motor'">
            Completa encabezado y evento (monto base, fecha, empresa y cuenta contrapartida).
          </ng-container>
        </span>

        <button type="submit" class="btn primary" [disabled]="!canGuardar()">
          Guardar póliza
        </button>
      </div>
    </form>
  </div>
</app-polizas-layout>

<app-modal-seleccion-cuenta
  [open]="modalCuentasAbierto"
  [cuentas]="cuentas"
  (cuentaConfirmada)="onCuentaSeleccionadaModal($event)"
  (cerrado)="cerrarModalCuentas()">
</app-modal-seleccion-cuenta>

<!-- Toast -->
<app-toast-message
  [open]="toast.open"
  [title]="toast.title"
  [message]="toast.message"
  [type]="toast.type"
  [position]="toast.position"
  [autoCloseMs]="toast.autoCloseMs"
  [showClose]="toast.showClose"
  (closed)="onToastClosed()">
</app-toast-message>
