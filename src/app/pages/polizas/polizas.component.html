<app-polizas-layout
  [open]="sidebarOpen"
  (openChange)="onSidebarToggle($event)">

  <!-- Volver -->
  <a [routerLink]="['/poliza-home']" style="text-decoration:none;">
    <button type="button" class="icon-btn" aria-label="Volver">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>
  </a>

  <div class="polizas-container">
    <hr />

    <h3>Nueva pÃ³liza</h3>

    <form
      class="form-poliza"
      (ngSubmit)="guardarPoliza()"
      #polizaForm="ngForm"
      autocomplete="off"
      novalidate>

      <h4 class="section-title">Cabecera de pÃ³liza</h4>

      <!-- Barra de ejercicio y usuario -->
      <div
        style="
          margin-left: auto;
          background: rgba(255, 255, 255, 0.08);
          border-radius: 8px;
          padding: 0.35rem 0.75rem;
          font-size: 0.9rem;
          color: #565656;
          display: flex;
          align-items: center;
          gap: 0.8rem;
        "
      >
        <!-- Ejercicio -->
        <div style="display: flex; align-items: center; gap: 0.4rem;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <path d="M3 4h18v2H3zM8 10h13v2H8zM8 16h13v2H8zM3 10h2v2H3zM3 16h2v2H3z"></path>
          </svg>
          <strong>Ejercicio:</strong>
          <select
            [(ngModel)]="ejercicioActualId"
            (ngModelChange)="onEjercicioSeleccionado($event)"
            name="ejercicioSeleccionado"
            style="margin-left: 0.5rem; background: transparent; border: none; color: #565656;"
          >
            <option *ngFor="let e of ejercicios; trackBy: trackByEjercicioId" [ngValue]="e.id_ejercicio">
              {{ e.anio || (e.fecha_inicio ? (e.fecha_inicio | date:'yyyy') : 'â€”') }}
            </option>
          </select>
          <span *ngIf="!ejercicios?.length" style="margin-left: 0.5rem;">â€”</span>
        </div>

        <div style="width: 1px; height: 20px; background: #ccc; opacity: 0.4;"></div>

        <!-- Usuario -->
        <div style="display: flex; align-items: center; gap: 0.4rem;">
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden="true"
          >
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          <span class="user-name">{{ currentUserLabel || 'Usuario' }}</span>
        </div>

        <div style="width: 1px; height: 20px; background: #ccc; opacity: 0.4;"></div>
      </div>

      <!-- Encabezado -->
      <div class="form-grid">

        <label>
          Tipo pÃ³liza:
          <select
            class="field select"
            [(ngModel)]="nuevaPoliza.id_tipopoliza"
            name="id_tipopoliza"
            required
            (ngModelChange)="onTipoPolizaChange($event)">
            <option [ngValue]="undefined" disabled>Seleccioneâ€¦</option>
            <option *ngFor="let t of tiposPoliza" [ngValue]="t.id_tipopoliza">{{ t.nombre }}</option>
          </select>
        </label>

        <!-- Periodo -->
        <label>
          Periodo:
          <select class="field select"
                  [(ngModel)]="nuevaPoliza.id_periodo"
                  name="id_periodo"
                  required
                  (ngModelChange)="onPeriodoChange($event)">
            <option [ngValue]="undefined" disabled>Seleccioneâ€¦</option>
            <option *ngFor="let p of periodos" [ngValue]="p.id_periodo">{{ p.nombre }}</option>
          </select>
        </label>

        <!-- Centro -->
         <label>
            Centro de costo:
            <button
              type="button"
              class="field select"
              name="id_centro"
              (click)="abrirModalCentro()">
              {{ labelCentroHeader(nuevaPoliza.id_centro) }}
            </button>
          </label>

        <label>
          Folio:
          <input class="field"
                [(ngModel)]="nuevaPoliza.folio"
                name="folio"
                required
                (input)="folioFueEditadoPorUsuario = true" />
        </label>

        <label class="status-label">
          <span>Estatus de pÃ³liza</span>
          <div class="status-chip por-revisar">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="black"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <circle cx="12" cy="16" r="1"></circle>
            </svg>
            <span>Por revisar</span>
          </div>
        </label>

        <label>
          Concepto:
          <input class="field"
                 [(ngModel)]="nuevaPoliza.concepto"
                 name="concepto"
                 required
                 (input)="conceptoFueEditadoPorUsuario = true" />

          <small *ngIf="conceptoSugerido && (!nuevaPoliza.concepto || !conceptoFueEditadoPorUsuario)"
                 style="display:block;margin-top:.25rem;color:#6b7280">
            Sugerencia: <em>{{ conceptoSugerido }}</em>
            <button type="button" class="btn small"
                    style="margin-left:.5rem"
                    (click)="aplicarConceptoSugerido()">
              Usar
            </button>
          </small>
        </label>
      </div>

      <!-- Modo manual -->
      <div *ngIf="modoCaptura==='manual'">
        <div class="movs-header">
          <h4 class="section-title">Movimientos</h4>

          <div style="display:flex; gap:.5rem; align-items:center;">
            <button type="button" class="btn pill" (click)="agregarMovimiento()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"
                   stroke-linecap="round" stroke-linejoin="round" class="icon">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Agregar movimiento
            </button>

            <!-- BotÃ³n Calculadora -->
            <button type="button" class="btn pill" (click)="abrirModalIva()">
              ðŸ§® Calculadora IVA
            </button>
          </div>
        </div>

        <div class="tabla-wrapper">
          <table class="tabla-movimientos">
            <thead>
              <tr>
                <th>Cuenta</th>
                <th>Serie Venta</th>
                <th>Concepto</th>
                <th>Fecha</th>
                <th>Centro Costo</th>
                <th>UUID</th>
                <th>Acciones</th>
                <!-- AHORA CARGO Y ABONO COMO ÃšLTIMAS DOS COLUMNAS -->
                <th>Cargo</th>
                <th>Abono</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let mov of (nuevaPoliza.movimientos ?? []); let i = index">
                <td class="cell-cuenta">
                  <button type="button" class="btn small" (click)="abrirModalCuentas(i)">
                    {{ labelCuenta(mov.id_cuenta) || 'Seleccionar cuentaâ€¦' }}
                  </button>
                </td>

                <td>
                  <input class="cell-input" [(ngModel)]="mov.ref_serie_venta" name="ref_serie_venta{{i}}" />
                </td>

                <td>
                  <input class="cell-input" [(ngModel)]="mov.cliente" name="cliente{{i}}" />
                </td>

                <td>
                  <input class="cell-input cell-date" type="date" [(ngModel)]="mov.fecha" name="fecha{{i}}" />
                </td>

                <td>
                  <select
                    class="cell-input select"
                    [(ngModel)]="mov.cc"
                    name="cc{{i}}"
                    (ngModelChange)="onMovimientoCcChange(i, $event)">
                    <option [ngValue]="null">â€” Selecciona CC â€”</option>
                    <option *ngFor="let cc of centrosCosto" [ngValue]="cc.id_centrocosto">
                      {{ cc.nombre }}
                    </option>
                  </select>
                </td>

                <td class="uuid-cell">
                  <div class="uuid-wrapper" [class.has-uuid]="!!mov.uuid">
                    <button
                      type="button"
                      class="btn-xml"
                      [ngClass]="{ ok: !!mov.uuid }"
                      [title]="mov.uuid ? 'XML asociado' : 'Cargar XML'"
                      (click)="triggerXmlPickerForMovimiento(xmlInputMov, i)">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                          width="18" height="18" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 5v14m-7-7h14"></path>
                      </svg>
                    </button>

                    <input
                      #xmlInputMov
                      type="file"
                      accept=".xml,text/xml,application/xml"
                      hidden
                      (change)="onXmlPickedForMovimiento($event, i)" />

                    <small class="uuid-badge" *ngIf="mov.uuid">{{ mov.uuid | slice:0:8 }}â€¦</small>
                  </div>
                </td>

                <td class="actions-cell">
                  <button
                    type="button"
                    class="icon-btn danger"
                    (click)="eliminarMovimiento(i)"
                    title="Eliminar movimiento"
                    aria-label="Eliminar movimiento">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"></path>
                      <path d="M10 11v6"></path>
                      <path d="M14 11v6"></path>
                      <path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"></path>
                    </svg>
                  </button>
                </td>

                <!-- CARGO (penÃºltima columna) -->
                <td>
                  <input
                    class="cell-input"
                    type="number"
                    min="0"
                    step="0.01"
                    name="cargo{{i}}"
                    [ngModel]="mov.operacion === '0' ? mov.monto : 0"
                    (ngModelChange)="onCargoChange(i, $event)" />
                </td>

                <!-- ABONO (Ãºltima columna) -->
                <td>
                  <input
                    class="cell-input"
                    type="number"
                    min="0"
                    step="0.01"
                    name="abono{{i}}"
                    [ngModel]="mov.operacion === '1' ? mov.monto : 0"
                    (ngModelChange)="onAbonoChange(i, $event)" />
                </td>
              </tr>
            </tbody>
          </table>

        </div>

        <!-- Totales -->
        <div class="totales-panel">
          <div class="tot-card">
            <div class="tot-label">TOTAL CARGOS</div>
            <div class="tot-value">
              {{ getTotal($any(nuevaPoliza), '0') | number:'1.2-2' }}
            </div>
          </div>

          <div class="tot-card">
            <div class="tot-label">TOTAL ABONOS</div>
            <div class="tot-value">
              {{ getTotal($any(nuevaPoliza), '1') | number:'1.2-2' }}
            </div>
          </div>

          <div class="tot-card">
            <div class="tot-label font-semibold"
                 [style.color]="getDiferencia($any(nuevaPoliza)) === 0 ? '#16a34a' : '#dc2626'">
              DIFERENCIA
            </div>
            <div class="tot-value font-bold"
                 [style.color]="getDiferencia($any(nuevaPoliza)) === 0 ? '#16a34a' : '#dc2626'">
              {{ getDiferencia($any(nuevaPoliza)) | number:'1.2-2' }}
            </div>
          </div>

          <div class="pill-status"
               [ngClass]="{ 'ok': getDiferencia($any(nuevaPoliza)) === 0, 'bad': getDiferencia($any(nuevaPoliza)) !== 0 }">
            <span class="icon" aria-hidden="true">
              {{ getDiferencia($any(nuevaPoliza)) === 0 ? 'âœ”' : 'âš ' }}
            </span>
            <span class="text">
              {{ getDiferencia($any(nuevaPoliza)) === 0 ? 'PÃ³liza cuadrada' : 'No cuadra' }}
            </span>
          </div>
        </div>
      </div>

      <div class="actions">
        <span *ngIf="!canGuardar()" class="hint error">
          <ng-container *ngIf="modoCaptura==='manual'">
            Completa folio, concepto, tipo, periodo, centro, usuario y cuadra partida doble.
          </ng-container>
          <ng-container *ngIf="modoCaptura==='motor'">
            Completa encabezado y evento (monto base, fecha, empresa y cuenta contrapartida).
          </ng-container>
        </span>

        <button type="submit" class="btn primary" [disabled]="!canGuardar()">
          Guardar pÃ³liza
        </button>
      </div>
    </form>
  </div>
</app-polizas-layout>

<!-- Modal selecciÃ³n de cuenta -->
<app-modal-seleccion-cuenta
  [open]="modalCuentasAbierto"
  [cuentas]="cuentas"
  (cuentaConfirmada)="onCuentaSeleccionadaModal($event)"
  (cerrado)="cerrarModalCuentas()">
</app-modal-seleccion-cuenta>

<!-- Modal selecciÃ³n de centro de costo -->
<app-modal-seleccion-cuenta
  [open]="modalCentroAbierto"
  [cuentas]="centrosCostoComoCuentas"
  [cuentaSeleccionada]="centroSeleccionadoModal"
  [noPosteablesComoTitulo]="false"
  [permitirSeleccionNoPosteables]="true"
  (cuentaConfirmada)="onCentroSeleccionadoModal($event)"
  (cerrado)="cerrarModalCentro()">
</app-modal-seleccion-cuenta>

<!-- Toast -->
<app-toast-message
  [open]="toast.open"
  [title]="toast.title"
  [message]="toast.message"
  [type]="toast.type"
  [position]="toast.position"
  [autoCloseMs]="toast.autoCloseMs"
  [showClose]="toast.showClose"
  (closed)="onToastClosed()">
</app-toast-message>

<!-- Modal Calculadora IVA -->
<app-modal
  [open]="modalIvaOpen"
  [title]="'Calculadora de IVA'"
  [size]="'md'"
  [showClose]="true"
  (closed)="cerrarModalIva()"
  (canceled)="cerrarModalIva()"
  (confirmed)="onConfirmarIva()">

  <form style="display:grid; gap:12px; padding-top:.25rem;">
    <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;">
      <label>
        OperaciÃ³n
        <select class="field select" [(ngModel)]="iva.op" name="iva_op">
          <option [ngValue]="'venta'">Venta</option>
          <option [ngValue]="'compra'">Compra</option>
        </select>
      </label>

      <label>
        Base
        <select
          class="field select"
          [(ngModel)]="iva.baseTipo"
          name="iva_base"
          (ngModelChange)="onBaseTipoChange($event)">
          <option [ngValue]="'sin'">Importe SIN IVA</option>
          <option [ngValue]="'con'">Precio CON IVA</option>
        </select>
      </label>

      <label>
        Tasa
        <select
          class="field select"
          [(ngModel)]="iva.tasa"
          name="iva_tasa"
          (ngModelChange)="onTasaChange($event)">
          <option [ngValue]="0.16">16%</option>
          <option [ngValue]="0.08">8%</option>
          <option [ngValue]="0.00">0% (gravado 0)</option>
          <option [ngValue]="'exento'">Exento</option>
        </select>
      </label>

      <label>
        Monto
        <input
          class="field"
          type="number"
          min="0"
          step="0.01"
          [(ngModel)]="iva.monto"
          name="iva_monto"
          (ngModelChange)="onMontoChange($event)" />
      </label>

      <label>
        Medio / contraparte
        <select class="field select" [(ngModel)]="iva.medio" name="iva_medio">
          <option [ngValue]="'bancos'">Bancos</option>
          <option [ngValue]="'caja'">Caja</option>
          <option [ngValue]="'clientes'">Clientes</option>
          <option [ngValue]="'proveedores'">Proveedores</option>
        </select>
      </label>

      <label>
        Concepto
        <input
          class="field"
          [(ngModel)]="iva.concepto"
          name="iva_concepto"
          placeholder="Ej. Venta mostrador folio 123">
      </label>
    </div>

    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;">
      <div class="tot-card">
        <div class="tot-label">Subtotal</div>
        <div class="tot-value">{{ iva.subtotal | number:'1.2-2' }}</div>
      </div>
      <div class="tot-card">
        <div class="tot-label">IVA</div>
        <div class="tot-value">{{ iva.iva | number:'1.2-2' }}</div>
      </div>
      <div class="tot-card">
        <div class="tot-label">Total</div>
        <div class="tot-value">{{ iva.total | number:'1.2-2' }}</div>
      </div>
    </div>

    <small class="hint" *ngIf="iva.tasa==='exento'">
      Exento: no se genera IVA por trasladar/acreditar. Solo se registran subtotal y medio.
    </small>
  </form>

</app-modal>
