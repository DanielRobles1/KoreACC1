<div class="layout" [class.is-collapsed]="!sidebarOpen"> 
  <app-sidebar
    class="sidebar"
    [open]="sidebarOpen"
    (openChange)="onSidebarToggle($event)">
  </app-sidebar>

  <div class="content">
    <app-crud-panel
      [title]="title"
      [tabs]="tabs"
      [activeTabId]="activeTabId"
      (tabChange)="onTabChange($event)"
      [primaryActionLabel]="primaryActionLabel"
      (primaryAction)="onPrimary()"
      [disablePrimary]="!canCreate"
      [columns]="columns"
      [data]="tableRows"
      [actions]="actions"
      (action)="onRowAction($event)"
      [page]="page"
      [totalPages]="totalPages"
      (search)="onSearch($event)">
    </app-crud-panel>
  </div>
</div>

<!-- Modal Crear/Editar -->
<app-modal
  [open]="modalOpen"
  [title]="modalTitle"
  [size]="modalSize"
  (closed)="closeModal()"
  (canceled)="cancelModal()"
  (confirmed)="roleFormRef.submitForm()">
  <app-role-form
    #roleFormRef
    [role]="editingRole"
    [availablePermissions]="availablePermissions"
    (submitted)="prepareUpsert($event)"
    (canceled)="cancelModal()">
  </app-role-form>
</app-modal>

<!-- Modal Confirmación: ELIMINAR -->
<app-modal
  [open]="confirmOpen"
  [title]="confirmTitle"
  size="sm"
  (closed)="closeConfirm()"
  (canceled)="cancelConfirm()"
  (confirmed)="confirmProceed()">
  <p class="mb-2">{{ confirmMessage }}</p>
</app-modal>

<!-- Modal Confirmación: GUARDAR (crear/editar) -->
<app-modal
  [open]="saveConfirmOpen"
  [title]="saveConfirmTitle"
  size="lg"
  (closed)="closeSaveConfirm()"
  (canceled)="cancelSaveConfirm()"
  (confirmed)="confirmSaveProceed()">
  <p class="mb-2">{{ saveConfirmMessage }}</p>
</app-modal>

<!-- Modal: SOLO PERMISOS -->
<app-modal
  [open]="permOpen"
  [title]="permTitle"
  size="xl"
  (closed)="permOpen = false"
  (canceled)="permOpen = false"
  (confirmed)="confirmPermissionsOnly()">

  <!-- Buscador de permisos -->
  <div class="flex items-center justify-between gap-3 mb-3 px-1">
    <div class="text-sm text-gray-600">
      Filtra permisos por nombre
    </div>
    <div class="flex items-center gap-2">
      <input
        type="text"
        [(ngModel)]="permissionSearch"
        placeholder="Buscar permiso..."
        class="px-3 py-2 border rounded-lg w-64"
        aria-label="Buscar permiso" />
      <button
        type="button"
        class="px-3 py-2 border rounded-lg hover:bg-gray-50"
        (click)="permissionSearch = ''">
        Limpiar
      </button>
    </div>
  </div>

  <!-- Grid por categorías en columnas -->
  <div class="max-h-96 overflow-auto">
    <div
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 p-1">

      <section
        class="border rounded-lg overflow-hidden"
        *ngFor="let cat of (groupedPermissions | keyvalue); trackBy: trackByCat">

        <header
          class="sticky top-0 bg-white/95 backdrop-blur px-3 py-2 border-b flex items-center justify-between">
          <h4 class="text-lg font-semibold">{{ cat.key }}</h4>

          <div class="flex items-center gap-2 text-xs">
            <span class="text-gray-600">
              {{ countSelectedInGroup(filterPerms(cat.value)) }}/{{ filterPerms(cat.value)?.length || 0 }}
            </span>

            <button
              type="button"
              class="px-2 py-1 rounded border hover:bg-gray-50"
              (click)="toggleGroup(cat.key, filterPerms(cat.value))">
              {{ areAllSelectedInGroup(filterPerms(cat.value)) ? 'Ninguno' : 'Todo' }}
            </button>
          </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1 px-3 py-2">
          <label
            class="flex items-center gap-2 py-1 cursor-pointer select-none"
            *ngFor="let p of filterPerms(cat.value); trackBy: trackByPerm"
            [for]="'perm_'+cat.key+'_'+p">
            <input
              type="checkbox"
              class="h-4 w-4"
              [id]="'perm_'+cat.key+'_'+p"
              [checked]="isPermSelected(p)"
              (change)="onPermCheckboxChange(p, $event)">
            <span class="text-lg">{{ formatPermission(p) }}</span>
          </label>
        </div>

        <div class="px-3 pb-3 text-sm text-gray-500" *ngIf="filterPerms(cat.value).length === 0">
          No hay permisos que coincidan con “{{ permissionSearch }}”.
        </div>
      </section>
    </div>
  </div>
</app-modal>

<app-toast-message
  [open]="noPermsOpen"
  [title]="noPermsTitle"
  [message]="noPermsMessage"
  type="warning"
  position="top-right"
  [autoCloseMs]="3500"
  (closed)="closeNoPerms()"
/>

<!-- TOAST ÉXITO -->
<app-toast-message
  [open]="successOpen"
  [title]="successTitle"
  [message]="successMessage"
  type="success"
  position="top-right"
  [autoCloseMs]="3000"
  (closed)="closeSuccess()"
/>

<!-- TOAST ERROR (sin autocierre) -->
<app-toast-message
  [open]="errorOpen"
  [title]="errorTitle"
  [message]="errorMessage"
  type="error"
  position="top-right"
  [autoCloseMs]="0"
  (closed)="closeError()"
/>