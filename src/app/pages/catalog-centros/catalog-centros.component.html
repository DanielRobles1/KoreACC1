<div class="layout" [class.is-collapsed]="!sidebarOpen">
  <app-sidebar
    class="sidebar"
    [open]="sidebarOpen"
    (openChange)="onSidebarToggle($event)">
  </app-sidebar>

  <div class="content">
      <div class="export-bar">
        <button class="btn-excel" (click)="exportToExcel()">Exportar Excel</button>
        <button class="btn-pdf" (click)="exportToPDF()"> Exportar PDF</button>

       <label class="btn-import" *ngIf="false">
  Importar Excel
  <input type="file" accept=".xlsx, .xls" (change)="onImportExcel($event)" hidden />
</label>

      </div>
      <app-crud-panel
        [title]="title"
        [tabs]="tabs"
        [activeTabId]="activeTabId"
        (tabChange)="onTabChange($event)"

        [primaryActionLabel]="primaryActionLabel"
        (primaryAction)="onPrimary()"
        [disablePrimary]="!canCreate"

        [projectContent]="true"
        (search)="onSearch($event)"
      >
        <ul class="tree-root">
          <ng-container *ngFor="let root of filteredTreeRoots">
            <ng-container
              *ngTemplateOutlet="treeNode; context: { $implicit: root }"
            ></ng-container>
          </ng-container>
        </ul>

        <ng-template #treeNode let-node>
          <li class="tree-node" [class.is-leaf]="!node.children?.length">
            <div class="tree-node__row">
              <button
                type="button"
                class="tree-toggle"
                *ngIf="node.children?.length"
                (click)="toggleNode(node, $event)"
              >
                {{ node.expanded ? '▾' : '▸' }}
              </button>

              <span class="tree-node__label">
                {{ node.data.nombre_centro }}
                <small>({{ node.data.serie_venta }})</small>
              </span>

              <span
                class="tree-pill"
                [class.tree-pill--inactive]="!node.data.activo"
              >
                {{ node.data.activo ? 'Activo' : 'Inactivo' }}
              </span>

              <button
                type="button"
                class="tree-action"
                *ngIf="canEdit"
                (click)="onEdit(node.data); $event.stopPropagation()"
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  width="20"
                  height="20">
                  <path d="M12 20h9"></path>
                  <path
                    d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
                </svg>
              </button>
              <button
                type="button"
                class="tree-action tree-action--danger"
                *ngIf="canDelete"
                (click)="askDelete(node.data, $event)"
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  width="18"
                  height="18">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"></path>
                  <path d="M10 11v6"></path>
                  <path d="M14 11v6"></path>
                  <path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"></path>
                </svg>
              </button>
            </div>

            <ul *ngIf="node.expanded && node.children?.length">
              <ng-container *ngFor="let child of node.children">
                <ng-container
                  *ngTemplateOutlet="treeNode; context: { $implicit: child }"
                ></ng-container>
              </ng-container>
            </ul>
          </li>
        </ng-template>
</app-crud-panel>
  </div>
</div>

<!-- MODAL: Crear/editar centro -->
<app-modal
  [open]="modalOpen"
  [title]="modalTitle"
  [size]="modalSize"
  [showClose]="true"
  (closed)="closeModal()"
  (canceled)="cancelModal()"
  (confirmed)="confirmCentroModal()">

  <form #centroForm="ngForm" class="form-grid" novalidate>
    <div class="field">
      <label class="field-label required">ID del centro</label>
      <input
        class="field-input"
        type="number"
        name="id_centro"
        [(ngModel)]="formCentro.id_centro"
        required
        placeholder="Código del centro"
        maxlength="20" />
    </div>

    <div class="field">
      <label class="field-label">ID del centro padre</label>
      <input
        class="field-input"
        type="number"
        name="parent_id"
        [(ngModel)]="formCentro.parent_id"
        placeholder="ID del centro padre (opcional)" />
      <div class="hint">Déjalo vacío para que sea un centro raíz.</div>
    </div>

    <div class="field">
      <label class="field-label required">Nombre del centro</label>
      <input
        class="field-input"
        type="text"
        name="nombre_centro"
        [(ngModel)]="formCentro.nombre_centro"
        required
        placeholder="Nombre"
        maxlength="150" />
    </div>

    <div class="field">
      <label class="field-label required">Serie de venta</label>
      <input
        class="field-input"
        type="text"
        name="serie_venta"
        [(ngModel)]="formCentro.serie_venta"
        required
        placeholder="Ej. A0"
        maxlength="50" />
    </div>

    <div class="field">
      <label class="field-label required">Región</label>
      <input
        class="field-input"
        type="text"
        name="region"
        [(ngModel)]="formCentro.region"
        required
        placeholder="Ej. Valles centrales"
        maxlength="80" />
    </div>

    <div class="field">
      <label class="field-label">Código Postal</label>
      <input
        class="field-input"
        type="text"
        name="cp"
        [(ngModel)]="formCentro.cp"
        maxlength="5"
        placeholder="C. P. XXXXX"
        pattern="^\d{5}$" />
      <div class="hint">Formato esperado: 5 dígitos.</div>
    </div>

    <div class="field">
      <label class="field-label">Calle</label>
      <input
        class="field-input"
        type="text"
        name="calle"
        [(ngModel)]="formCentro.calle"
        maxlength="120"
        placeholder="Calle" />
    </div>

    <div class="field">
      <label class="field-label">Número exterior</label>
      <input
        class="field-input"
        type="text"
        name="num_ext"
        [(ngModel)]="formCentro.num_ext"
        maxlength="20"
        placeholder="Número exterior" />
    </div>

    <div class="field">
      <label class="field-label">Número interior</label>
      <input
        class="field-input"
        type="text"
        name="num_int"
        [(ngModel)]="formCentro.num_int"
        maxlength="20"
        placeholder="Número interior" />
    </div>

    <div class="field">
      <label class="field-label">Teléfono</label>
      <input
        class="field-input"
        type="text"
        name="telefono"
        [(ngModel)]="formCentro.telefono"
        maxlength="20"
        placeholder="951-XXX-XX-XX" />
    </div>

    <div class="field col-span-2">
      <label class="field-label">Correo de contacto</label>
      <input
        class="field-input"
        type="email"
        name="correo"
        [(ngModel)]="formCentro.correo"
        maxlength="120"
        placeholder="ejemplo@gmail.com" />
    </div>

    <div class="field switch-line col-span-2">
      <label class="field-label">Estatus</label>
      <label class="switch">
        <input
          type="checkbox"
          name="activo"
          [(ngModel)]="formCentro.activo" />
        <span>Activo</span>
      </label>
    </div>

    <div class="form-note col-span-2">
      Los campos marcados con <b>*</b> son obligatorios.
    </div>
  </form>
</app-modal>

<!-- MODAL DE CONFIRMACIÓN -->
<app-modal
  [open]="confirmOpen"
  [title]="confirmTitle"
  size="sm"
  (closed)="closeConfirm()"
  (canceled)="cancelConfirm()"
  (confirmed)="confirmProceed()"
>
  <p style="margin:0 0 .5rem 0;">{{ confirmMessage }}</p>
</app-modal>

<app-toast-message
  [open]="vm.open"
  [title]="vm.title"
  [message]="vm.message"
  [type]="vm.type"
  position="top-right"
  [autoCloseMs]="vm.autoCloseMs"
  (closed)="toast.close()"
/>