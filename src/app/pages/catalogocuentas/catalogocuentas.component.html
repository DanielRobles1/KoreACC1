<div class="layout" [class.is-collapsed]="!sidebarOpen">
  <app-sidebar
    class="sidebar"
    [open]="sidebarOpen"
    (openChange)="onSidebarToggle($event)">
  </app-sidebar>

  <div class="content">
    <div class="crud-wrapper">
      
      <!-- Barra de botones de exportación/importación -->
      <div class="export-bar">
        <button class="btn-excel" (click)="exportToExcel()">Exportar Excel</button>
        <button class="btn-pdf" (click)="exportToPDF()"> Exportar PDF</button>

    <label class="btn-import" *ngIf="false">
  Importar Excel
  <input type="file" accept=".xlsx, .xls" (change)="importFromExcel($event)" hidden />
</label>


      </div>
    

      <app-crud-panel
        [title]="title"
        [tabs]="tabs"
        [activeTabId]="activeTabId"
        (tabChange)="onTabChange($event)"
        [primaryActionLabel]="primaryActionLabel"
        (primaryAction)="onPrimary()"
        [disablePrimary]="!canEdit"
        [data]="filteredRows"

        [columns]="columns"
        [data]="rows"              
        [actions]="actions"
        [showSearch]="true"        
        [hidePrimary]="false"
        (search)="onSearch($event)"

        (edit)="onEdit($event)"
        (action)="onRowAction($event)">
      </app-crud-panel>
    </div>
  </div>
</div>


<!-- Modal de edición -->
<app-modal
  [open]="editOpen"
  [title]="modalTitle"
  [size]="modalSize"
  [showClose]="showClose"
  (closed)="closeModal()"
  (canceled)="cancelModal()"
  (confirmed)="confirmModal()">

  <form #cuentaForm="ngForm" style="display: grid; gap: 10px;">
    
    <div>
      <label class="field-label required">Código</label>
      <input
        class="field-input"
        type="text"
        name="codigo"
        [(ngModel)]="formCuenta.codigo"
        (ngModelChange)="onFieldChange('codigo', $event)"
        required
        maxlength="20"
        placeholder="Ej. 1000 o 1001-01" />
      <small *ngIf="touched.codigo && errors.codigo"
        style="color:rgb(247, 39, 39); display:block; margin-top:4px; font-weight:bold;">
        {{ errors.codigo }}
      </small>
    </div>

    
    <div>
      <label class="field-label required">Nombre de cuenta</label>
      <input
        class="field-input"
        type="text"
        name="nombre"
        [(ngModel)]="formCuenta.nombre"
        (ngModelChange)="onFieldChange('nombre', $event)"
        required
        maxlength="100"
        placeholder="Ej. Caja general, Banco BBVA, Ventas" />
      <small *ngIf="touched.nombre && errors.nombre"
        style="color:rgb(247, 58, 58); display:block; margin-top:4px; font-weight:bold;">
        {{ errors.nombre }}
      </small>
    </div>

    <!-- Toggle cuenta mayor -->
    <div style="display: flex; align-items: center; gap: 8px;">
      <label class="field-label" style="margin: 0;">Cuenta mayor</label>
      <input type="checkbox" name="ctaMayor" [(ngModel)]="formCuenta.ctaMayor" (ngModelChange)="onCtaMayorChange($event)"/>
      <span style="font-size: 12px; opacity: 0.8;">
        (si se marca, puede tener subcuentas)
      </span>
    </div>

    <!-- Clasificación contable -->
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
      <div>
        <label class="field-label required">Tipo</label>
        <select class="field-input" name="tipo" required [(ngModel)]="formCuenta.tipo">
          <option *ngFor="let t of TIPO_OPTS" [ngValue]="t">{{ t }}</option>
        </select>
      </div>
      <div>
        <label class="field-label required">Naturaleza</label>
        <select class="field-input" name="naturaleza" required [(ngModel)]="formCuenta.naturaleza">
          <option *ngFor="let n of NAT_OPTS" [ngValue]="n">{{ n }}</option>
        </select>
      </div>
    </div>

    <!-- Posteable: disabled no puede recibir undefined -->
    <div style="display:flex; align-items:center; gap:8px;">
      <label class="field-label" style="margin:0;">Posteable</label>
      <input
        type="checkbox"
        name="posteable"
        [(ngModel)]="formCuenta.posteable"
        [disabled]="!!formCuenta.ctaMayor" />
      <span style="font-size:12px; opacity:.8;">
        <ng-container *ngIf="!!formCuenta.ctaMayor">
          (Las cuentas mayor no son posteables)
        </ng-container>
        <ng-container *ngIf="!formCuenta.ctaMayor">
          (Las subcuentas pueden ser posteables)
        </ng-container>
      </span>
    </div>

    <!-- Cuenta padre -->
    <div *ngIf="!formCuenta.ctaMayor">
      <label class="field-label">Cuenta padre</label>
      <select class="field-input" name="parentId" [(ngModel)]="formCuenta.parentId">
        <option [ngValue]="null">— Sin padre —</option>
        <option *ngFor="let c of getParentOptions()" [ngValue]="c.id">
          {{ c.codigo }} - {{ c.nombre }}
        </option>
      </select>

      <div *ngIf="parentPreselectedId" style="font-size: 12px; opacity: 0.8; margin-top:4px;">
        Se creará como subcuenta de
        <strong>{{ getCodigoPadre(parentPreselectedId) }}</strong>
      </div>
    </div>
  </form>
</app-modal>

<!--  Modal de confirmación -->
<app-modal
  [open]="confirmOpen"
  [title]="confirmTitle"
  [size]="'sm'"
  [showClose]="true"
  (closed)="closeConfirm()"
  (canceled)="cancelConfirm()"
  (confirmed)="confirmProceed()">
  <p style="margin:0">{{ confirmMessage }}</p>
</app-modal>

<!-- Toast -->
<app-toast-message
  [open]="vm.open"
  [title]="vm.title"
  [message]="vm.message"
  [type]="vm.type"
  position="top-right"
  [autoCloseMs]="vm?.autoCloseMs ?? 3500"
  (closed)="vm.open = false">
</app-toast-message>
