<button
  class="sidebar-toggle"
  type="button"
  (click)="toggleSidebar()"
  [attr.aria-label]="open ? 'Contraer menú' : 'Expandir menú'"
  [attr.aria-expanded]="open"
>
  <svg
    *ngIf="open"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    width="22"
    height="22"
  >
    <polyline points="15 18 9 12 15 6"></polyline>
  </svg>

  <svg
    *ngIf="!open"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    width="22"
    height="22"
  >
    <polyline points="9 6 15 12 9 18"></polyline>
  </svg>
</button>

<div class="sidebar-shell">
  <div class="sidebar-header">
    <div class="logo-section">
      <img src="assets/svgs/Kore-ACC.svg" alt="Logo" class="logo-img" />
      <h2 class="logo-title">Kore ACC</h2>
    </div>

    <div *ngIf="user" class="user-section">
      <!-- <div class="user-avatar" (click)="openEditProfile()">
        {{ user.nombre?.charAt(0)?.toUpperCase() }}
      </div> -->
      <p class="user-name" (click)="openEditProfile()">
        {{ user.nombre }}
      </p>
    </div>

    <app-edit-profile-modal
      [open]="editProfileOpen"
      [user]="tempUser"
      (closed)="closeEditProfile()"
      (saved)="saveProfile($event)"
    >
    </app-edit-profile-modal>
  </div>

  <!-- Contenido principal con scroll -->
  <div class="sidebar-content">
    <nav class="main-nav">
      <!-- Pólizas -->
      <div class="nav-item">
        <button
          type="button"
          class="btn"
          [routerLink]="['/poliza-home']"
          routerLinkActive="btn--active"
          [routerLinkActiveOptions]="{ exact: true }"
        >
          <img src="assets/svgs/poliza.svg" alt="Pólizas" class="icon" />
          <span class="btn-text">Pólizas</span>
        </button>
      </div>

      <!-- Reportes -->
      <div class="nav-item">
        <button
          type="button"
          class="btn"
          [class.btn--active]="
            reportesOpen ||
            router.url.includes('/balance-general') ||
            router.url.includes('/balanza-comprobacion') ||
            router.url.includes('/estado-resultados')
          "
          (click)="toggleReportes()"
          (mouseenter)="openReportes()"
          (mouseleave)="scheduleCloseReportes()"
        >
          <img src="assets/svgs/reportes.svg" alt="Reportes" class="icon" />
          <span class="btn-text">Reportes</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="caret"
            [class.caret--open]="reportesOpen"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            />
          </svg>
        </button>

        <ul 
          class="submenu" 
          *ngIf="reportesOpen"
          (mouseenter)="cancelCloseReportes()"
          (mouseleave)="scheduleCloseReportes()"
        >
          <li>
            <a
              class="subbtn"
              [routerLink]="'/balance-general'"
              routerLinkActive="subbtn--active"
              (click)="setActive('reportes')"
            >
              <img
                src="assets/svgs/reporte-opciones.svg"
                class="icon-sm"
                alt="Balance general"
              />
              <span class="subbtn-text">Balance general</span>
            </a>
          </li>
          <li>
            <a
              class="subbtn"
              [routerLink]="'/balanza-comprobacion'"
              routerLinkActive="subbtn--active"
              (click)="setActive('reportes')"
            >
              <img
                src="assets/svgs/reporte-opciones.svg"
                class="icon-sm"
                alt="Balanza de comprobación"
              />
              <span class="subbtn-text">Balanza de comprobación</span>
            </a>
          </li>
          <li>
            <a
              class="subbtn"
              [routerLink]="'/estado-resultados'"
              routerLinkActive="subbtn--active"
              (click)="setActive('reportes')"
            >
              <img
                src="assets/svgs/reporte-opciones.svg"
                class="icon-sm"
                alt="Estado de resultados"
              />
              <span class="subbtn-text">Estado de resultados</span>
            </a>
          </li>
        </ul>
      </div>

      <!-- Dashboard -->
      <div class="nav-item">
        <button
          type="button"
          class="btn"
          [routerLink]="['/dashboard-contable']"
          routerLinkActive="btn--active"
          (click)="setActive('dashboard')"
        >
          <img src="assets/svgs/dashboard.svg" alt="Dashboard" class="icon" />
          <span class="btn-text">Dashboard</span>
        </button>
      </div>

      <!-- Separador visual -->
      <div class="nav-divider"></div>

      <!-- Configuración -->
      <div class="nav-item">
        <button
          type="button"
          class="btn"
          [class.btn--active]="
            configOpen ||
            usuariosPermisosOpen ||
            catalogosOpen ||
            empresaOpen ||
            router.url.includes('/usuarios') ||
            router.url.includes('/login/roles') ||
            router.url.includes('/catalogos') ||
            router.url.includes('/centros-costo') ||
            router.url.includes('/empresa') ||
            router.url.includes('/impuestos')
          "
          (click)="toggleConfiguracion()"
          (mouseenter)="openConfiguracion()"
          (mouseleave)="scheduleCloseConfig()"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="icon"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
          </svg>
          <span class="btn-text">Configuración</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="caret"
            [class.caret--open]="configOpen"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            />
          </svg>
        </button>

        <ul 
          class="submenu" 
          *ngIf="configOpen"
          (mouseenter)="cancelCloseConfig()"
          (mouseleave)="scheduleCloseConfig()"
        >
          <!-- Usuarios / Permisos -->
          <li>
            <button
              type="button"
              class="btn btn--sub"
              [class.btn--active]="
                usuariosPermisosOpen ||
                router.url.includes('/usuarios') ||
                router.url.includes('/login/roles')
              "
              (click)="toggleUsuariosPermisos()"
              (mouseenter)="openUsuariosPermisos()"
              (mouseleave)="scheduleCloseUsuariosPermisos()"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                class="icon-sm"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15.75 7.5a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z
                     M4.5 20.25a8.25 8.25 0 0115 0"
                />
              </svg>
              <span class="btn-text">Usuarios / Permisos</span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="caret caret--sm"
                [class.caret--open]="usuariosPermisosOpen"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </button>

            <ul 
              class="submenu submenu--nested" 
              *ngIf="usuariosPermisosOpen"
              (mouseenter)="cancelCloseUsuariosPermisos()"
              (mouseleave)="scheduleCloseUsuariosPermisos()"
            >
              <li>
                <a
                  [routerLink]="['/usuarios']"
                  class="subbtn"
                  routerLinkActive="subbtn--active"
                  (click)="setActive('usuarios-permisos')"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="icon-sm"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 
                 3.75 0 017.5 0zM4.5 20.25a8.25 
                 8.25 0 1115 0v.75H4.5v-.75z"
                    />
                  </svg>
                  <span class="subbtn-text">Usuarios</span>
                </a>
              </li>
              <li>
                <a
                  [routerLink]="['/login/roles']"
                  class="subbtn"
                  routerLinkActive="subbtn--active"
                  (click)="setActive('usuarios-permisos')"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="icon-sm"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M9 12.75l2.25 2.25L15 9.75M12 
                 2.25c-4.97 0-9 2.686-9 
                 6v4.5c0 4.314 4.03 7.5 9 
                 7.5s9-3.186 9-7.5V8.25c0-3.314-4.03-6-9-6z"
                    />
                  </svg>
                  <span class="subbtn-text">Permisos</span>
                </a>
              </li>
            </ul>
          </li>

          <!-- Catálogos -->
          <li>
            <button
              type="button"
              class="btn btn--sub"
              [class.btn--active]="
                catalogosOpen ||
                router.url.includes('/catalogos/cuentas') ||
                router.url.includes('/centros-costo')
              "
              (click)="toggleCatalogos()"
              (mouseenter)="openCatalogos()"
              (mouseleave)="scheduleCloseCatalogos()"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                class="icon-sm"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M4.5 6.75A2.25 2.25 0 016.75 4.5h10.5
                     A2.25 2.25 0 0119.5 6.75v10.5
                     A2.25 2.25 0 0117.25 19.5H6.75
                     A2.25 2.25 0 014.5 17.25V6.75z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M9 8.25h6M9 12h6M9 15.75h3"
                />
              </svg>
              <span class="btn-text">Catálogos</span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="caret caret--sm"
                [class.caret--open]="catalogosOpen"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </button>

            <ul 
              class="submenu submenu--nested" 
              *ngIf="catalogosOpen"
              (mouseenter)="cancelCloseCatalogos()"
              (mouseleave)="scheduleCloseCatalogos()"
            >
              <li>
                <a
                  [routerLink]="['/catalogos/cuentas']"
                  class="subbtn"
                  routerLinkActive="subbtn--active"
                  (click)="setActive('catalogos')"
                >
                  <img
                    src="assets/svgs/catalog-cuentas.svg"
                    class="icon-sm"
                    alt="Cuentas"
                  />
                  <span class="subbtn-text">Cuentas</span>
                </a>
              </li>
              <li>
                <a
                  [routerLink]="['/centros-costo']"
                  class="subbtn"
                  routerLinkActive="subbtn--active"
                  (click)="setActive('catalogos')"
                >
                  <img
                    src="assets/svgs/catalogue-catalog.svg"
                    class="icon-sm"
                    alt="Centros de costo"
                  />
                  <span class="subbtn-text">Centros de costo</span>
                </a>
              </li>
            </ul>
          </li>

          <!-- Empresa / Periodos -->
          <li>
            <button
              type="button"
              class="btn btn--sub"
              [class.btn--active]="
                empresaOpen ||
                router.url.includes('/empresa') ||
                router.url.includes('/impuestos')
              "
              (click)="toggleEmpresa()"
              (mouseenter)="openEmpresa()"
              (mouseleave)="scheduleCloseEmpresa()"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                class="icon-sm"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3.75 20.25h16.5M4.5 9.75L12 3l7.5 6.75
                     M6.75 20.25v-6h3v6
                     M14.25 20.25v-6h3v6"
                />
              </svg>
              <span class="btn-text">Empresa / Periodo</span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="caret caret--sm"
                [class.caret--open]="empresaOpen"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </button>

            <ul 
              class="submenu submenu--nested" 
              *ngIf="empresaOpen"
              (mouseenter)="cancelCloseEmpresa()"
              (mouseleave)="scheduleCloseEmpresa()"
            >
              <li>
                <a
                  [routerLink]="['/empresa']"
                  class="subbtn"
                  routerLinkActive="subbtn--active"
                  (click)="setActive('empresa')"
                >
                  <img
                    src="assets/svgs/taxes.svg"
                    class="icon-sm"
                    alt="Empresa"
                  />
                  <span class="subbtn-text">Periodos</span>
                </a>
              </li>
              <li>
                <a
                  [routerLink]="['/empresas']"
                  class="subbtn"
                  routerLinkActive="subbtn--active"
                  (click)="setActive('empresa')"
                >
                  <img
                    src="assets/svgs/company.svg"
                    class="icon-sm"
                    alt="Impuestos"
                  />
                  <span class="subbtn-text">Empresa</span>
                </a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </nav>
  </div>

  <!-- Footer fijo -->
  <div class="sidebar-footer">
    <button
      type="button"
      class="btn btn--logout"
      (click)="openLogoutConfirm()"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="icon"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
        />
      </svg>
      <span class="btn-text">Cerrar sesión</span>
    </button>
  </div>

  <!-- Modal confirmación -->
  <app-modal
    [open]="confirmOpen"
    [title]="confirmTitle"
    size="sm"
    (closed)="closeConfirm()"
    (canceled)="cancelConfirm()"
    (confirmed)="confirmProceed()"
  >
    <p class="mb-2">{{ confirmMessage }}</p>
  </app-modal>
</div>